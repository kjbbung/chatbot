<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>일학습병행 전문 상담 챗봇</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: 'Inter', sans-serif; background: #f5f5f7; color: #111827; }
    .container { display: flex; flex-direction: column; height: 100vh; max-width: 700px; margin: 0 auto; background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    header { padding: 16px; background: #2563eb; color: #fff; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1d4ed8; }
    header h1 { font-size: 1.2rem; font-weight: 700; }
    header img { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; }
    #chat { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .msg-wrap { display: flex; }
    .msg-wrap.user { justify-content: flex-end; }
    .msg-wrap.bot { justify-content: flex-start; }
    .bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 0.875rem; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }
    .bubble.user { background: #2563eb; color: #fff; border-bottom-right-radius: 2px; }
    .bubble.bot { background: #f3f4f6; color: #111827; border-bottom-left-radius: 2px; }
    .bubble.error { background: #fee2e2; color: #b91c1c; border-bottom-left-radius: 2px; }
    #loading { padding: 4px 16px 8px; color: #9ca3af; font-size: 0.8rem; display: none; }
    .input-area { padding: 12px 16px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; }
    #userInput { flex: 1; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 12px; font-size: 0.875rem; outline: none; }
    #userInput:focus { border-color: #2563eb; }
    #sendBtn { background: #2563eb; color: #fff; border: none; border-radius: 8px; padding: 8px 18px; font-size: 0.875rem; cursor: pointer; }
    #sendBtn:hover { background: #1d4ed8; }
    #sendBtn:disabled { background: #93c5fd; cursor: not-allowed; }
    #quota-warning { display: none; background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 10px 16px; font-size: 0.8rem; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>일학습병행 전문 상담 챗봇</h1>
      <img src="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" alt="봇 아이콘">
    </header>
    <div id="quota-warning">현재 API 사용량 한도에 도달했습니다. 임시적인 오류입니다. 잠시 후 다시 시도해 주세요.</div>
    <div id="chat"></div>
    <div id="loading">답변을 생성하는 중...</div>
    <div class="input-area">
      <input type="text" id="userInput" placeholder="마음껏 물어보세요!" />
      <button id="sendBtn">전송</button>
    </div>
  </div>
  <script>
    const API_KEY = 'AIzaSyAxXVR-9-ei7VWzczoG5WONgZGFvkLQSgU';
    const MODEL = 'gemini-2.5-flash';
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
    const SYSTEM_PROMPT = `당신은 일학습병행제도 전문 상담 챗봇입니다.
일학습병행제도, 일·학습병행, 기업현장교사, 훈련생 등록, 지원금, 자격취득 등 관련 질문에 친절하고 정확하게 답변해 주세요.
모든 답변은 한국어로 해주세요.`;
    const chatHistory = [];
    let quotaExceeded = false;
    function showQuotaWarning() {
      quotaExceeded = true;
      document.getElementById('quota-warning').style.display = 'block';
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('userInput').disabled = true;
    }
    function addMessage(role, text, isError) {
      const chat = document.getElementById('chat');
      const wrap = document.createElement('div');
      wrap.className = `msg-wrap ${role}`;
      const bubble = document.createElement('div');
      bubble.className = `bubble ${isError ? 'error' : role}`;
      bubble.textContent = text;
      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }
    async function sendMessage() {
      if (quotaExceeded) return;
      const input = document.getElementById('userInput');
      const btn = document.getElementById('sendBtn');
      const loading = document.getElementById('loading');
      const text = input.value.trim();
      if (!text) return;
      addMessage('user', text, false);
      chatHistory.push({ role: 'user', parts: [{ text }] });
      input.value = '';
      btn.disabled = true;
      loading.style.display = 'block';
      try {
        const contents = [
          { role: 'user', parts: [{ text: SYSTEM_PROMPT }] },
          { role: 'model', parts: [{ text: '네, 일학습병행제도에 대해 친절하게 안내해 드리겠습니다.' }] },
          ...chatHistory
        ];
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents,
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 8192
            }
          })
        });
        const data = await res.json();
        if (!res.ok) {
          const errMsg = data?.error?.message || '알 수 없는 오류';
          if (res.status === 429 || errMsg.toLowerCase().includes('quota') || errMsg.toLowerCase().includes('resource_exhausted')) {
            showQuotaWarning();
            addMessage('bot', 'API 사용량 한도에 도달했습니다. 잠시 후 다시 시도해 주세요.', true);
          } else if (res.status === 403) {
            addMessage('bot', `API 키 권한 오류입니다: ${errMsg}`, true);
          } else {
            addMessage('bot', `오류 (${res.status}): ${errMsg}`, true);
          }
          chatHistory.pop();
          return;
        }
        const finishReason = data?.candidates?.[0]?.finishReason;
        let reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || '응답을 받지 못했습니다.';
        if (finishReason === 'MAX_TOKENS') {
          reply += '\n\n[답변이 길어 일부가 생략되었습니다. "이어서 설명해줘"]라고 입력하면 이어서 답변할 수 있습니다.]';
        }
        chatHistory.push({ role: 'model', parts: [{ text: reply }] });
        addMessage('bot', reply, false);
      } catch (e) {
        addMessage('bot', `네트워크 오류: ${e.message}`, true);
        chatHistory.pop();
      } finally {
        loading.style.display = 'none';
        if (!quotaExceeded) btn.disabled = false;
        input.focus();
      }
    }
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('userInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    window.addEventListener('load', function() {
      addMessage('bot', '안녕하세요! 일학습병행제도 전문 상담 챗봇입니다. 궁금한 점을 마음껏 물어보세요!', false);
    });
  </script>
</body>
</html>
